name: Daily Export to S3

on:
     
  schedule:
    
    - cron: '30 4 * * *'

env:
  CLICKHOUSE_HOST: ${{ secrets.CLICKHOUSE_HOST }}
  CLICKHOUSE_PORT: ${{ secrets.CLICKHOUSE_PORT }}
  CLICKHOUSE_USER: ${{ secrets.CLICKHOUSE_USER }}
  CLICKHOUSE_PASSWORD: ${{ secrets.CLICKHOUSE_PASSWORD }}
  CUSTOMER_ID: ${{ vars.CUSTOMER_ID || secrets.CUSTOMER_ID }}
  EXPORT_DATE: ${{ vars.EXPORT_DATE }}

jobs:
  export:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ClickHouse client
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-transport-https ca-certificates curl gnupg
          curl -fsSL 'https://packages.clickhouse.com/rpm/lts/repodata/repomd.xml.key' | sudo gpg --dearmor -o /usr/share/keyrings/clickhouse-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.gpg] https://packages.clickhouse.com/deb stable main" | sudo tee /etc/apt/sources.list.d/clickhouse.list
          sudo apt-get update
          sudo apt-get install -y clickhouse-client

      - name: Validate customer ID
        run: |
          if [ -z "$CUSTOMER_ID" ]; then
            echo "::error::CUSTOMER_ID is not set. Add it as a repository Variable (Settings → Secrets and variables → Actions → Variables) or Secret named CUSTOMER_ID."
            exit 1
          fi
          echo "Daily export for customer: $CUSTOMER_ID (date: ${EXPORT_DATE:-yesterday})"

      - name: Make script executable
        run: chmod +x ./scripts/export_to_s3.sh

      - name: Run export
        run: ./scripts/export_to_s3.sh
        env:
          CUSTOMER_ID: ${{ env.CUSTOMER_ID }}
          EXPORT_DATE: ${{ env.EXPORT_DATE }}
          CLICKHOUSE_SECURE: "1"
          NAMED_COLLECTION: aws_production_s3
          EXPORT_PATH: exports
          S3_URL: ${{ secrets.S3_URL }}
          S3_KEY: ${{ secrets.S3_KEY }}
          S3_ACCESS: ${{ secrets.S3_ACCESS }}

      - name: Export summary
        if: success()
        run: |
          echo "### Daily Export Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Customer ID:** ${{ env.CUSTOMER_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Export date:** ${{ env.EXPORT_DATE || 'yesterday' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
